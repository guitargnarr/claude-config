# Complete Guitar Reference Book -- Implementation Plan

## Scope

One PDF containing all 12 keys, all 5 positions, all 8 exercise types, and companion chords for each scale type. Structured as a guitar teacher would organize a lesson book.

---

## 1. Document Structure (The "Book" Outline)

```
TITLE PAGE
  "Complete Guitar Scale Reference"
  "12 Keys -- 5 Positions -- 8 Exercises -- Companion Chords"
  "Generated by mirador-tab-generator -- verified fretboard math"

TABLE OF CONTENTS (auto-generated by LaTeX)

PHASE 1: FOUNDATION (Part I)
  Chapter: A Minor Pentatonic    <-- start with the friendliest key
    Section: Scale Positions
      Position 1 (frets 5-8) -- tab + note legend
      Position 2 (frets 8-10) -- tab + note legend
      Position 3 ...
      Position 4 ...
      Position 5 ...
    Section: Companion Chords
      Am (tab), Dm (tab), Em (tab), C (tab), G (tab)
      "Try this progression: Am - Dm - Em - Am"
    Section: Exercises -- Position 1
      Ascending, Descending, Legato, Sequence3, Sequence4,
      String-skip, Alternate Picking, Triplet
    Section: Exercises -- Position 2
      (same 8 types)
    ... through Position 5

  Chapter: E Minor Pentatonic
    (same structure)
  Chapter: D Minor Pentatonic
  Chapter: G Minor Pentatonic
  Chapter: C Minor Pentatonic
  Chapter: B Minor Pentatonic

PHASE 2: SHARPS & FLATS (Part II)
  Chapter: F# Minor Pentatonic
  Chapter: Bb Minor Pentatonic
  Chapter: Eb Minor Pentatonic
  Chapter: Ab Minor Pentatonic
  Chapter: Db Minor Pentatonic
  Chapter: F Minor Pentatonic

APPENDIX
  All chord voicing shapes reference (one-page summary)
  Quick reference: which chords go with which key
```

**Key ordering**: Not chromatic (C, C#, D...). Instead, ordered by practical difficulty:
- Phase 1: A, E, D, G, C, B (the "natural" keys guitarists learn first)
- Phase 2: F#, Bb, Eb, Ab, Db, F (sharps/flats keys)

**Page estimate**: ~125-140 pages total.

---

## 2. Chord Voicing System

### Approach: Shape-based (CAGED system), not brute-force computed

Guitar chord voicings must be physically playable. Rather than computing all possible note placements and filtering, use proven barre chord shapes and transpose them.

### New data structure in `mirador-tab-generator`:

```python
# Barre chord shapes: (root_string_index, [fret_offsets_per_string])
# -1 = muted string, offsets are relative to the root note's fret
BARRE_SHAPES = {
    'major_E':  (0, [0, 2, 2, 1, 0, 0]),
    'major_A':  (1, [-1, 0, 2, 2, 2, 0]),
    'minor_E':  (0, [0, 2, 2, 0, 0, 0]),
    'minor_A':  (1, [-1, 0, 2, 2, 1, 0]),
    'dom7_E':   (0, [0, 2, 0, 1, 0, 0]),
    'dom7_A':   (1, [-1, 0, 2, 0, 2, 0]),
    'min7_E':   (0, [0, 2, 0, 0, 0, 0]),
    'min7_A':   (1, [-1, 0, 2, 0, 1, 0]),
    'maj7_A':   (1, [-1, 0, 2, 1, 2, 0]),
    'dim_A':    (1, [-1, 0, 1, 2, 1, -1]),
    'aug_E':    (0, [0, 3, 2, 1, 1, 0]),
    'sus2_A':   (1, [-1, 0, 2, 2, 0, 0]),
    'sus4_E':   (0, [0, 2, 2, 2, 0, 0]),
    'power_E':  (0, [0, 2, 2, -1, -1, -1]),
    'power_A':  (1, [-1, 0, 2, 2, -1, -1]),
}

# Map chord type to preferred shape
CHORD_TYPE_SHAPES = {
    'major': 'major_E',
    'minor': 'minor_E',
    'dom7':  'dom7_E',
    'min7':  'min7_E',
    'maj7':  'maj7_A',
    'dim':   'dim_A',
    'aug':   'aug_E',
    'sus2':  'sus2_A',
    'sus4':  'sus4_E',
    'power': 'power_E',
}
```

### New functions in `mirador-tab-generator`:

```python
def get_chord_voicing(root, chord_type):
    """Return a list of 6 fret values (int or 'X') for a playable chord voicing."""
    shape_key = CHORD_TYPE_SHAPES[chord_type]
    root_string, offsets = BARRE_SHAPES[shape_key]
    root_frets = fret_for_note(root_string, root, 0, 12)
    barre_fret = root_frets[0]
    voicing = []
    for s in range(6):
        if offsets[s] == -1:
            voicing.append('X')
        else:
            voicing.append(barre_fret + offsets[s])
    return voicing

def render_chord_tab(voicings):
    """Render multiple chord voicings side-by-side as tab.
    
    voicings: list of (chord_name, [fret_values]) tuples
    Returns formatted tab string with chord names above.
    """
    # Header line with chord names spaced above columns
    # Then 6 tab lines with fret numbers aligned vertically
    
def get_companion_chords(root, scale_type):
    """Return list of (chord_root, chord_type, chord_name) for key-appropriate chords."""
    # Uses diatonic harmony to pick 4-5 chords that work with the scale
```

### Diatonic chord mapping:

```python
DIATONIC_QUALITIES = {
    'natural-minor':  ['minor','dim','major','minor','minor','major','major'],
    'natural-major':  ['major','minor','minor','major','major','minor','dim'],
    'harmonic-minor': ['minor','dim','aug','minor','major','major','dim'],
    'dorian':         ['minor','minor','major','major','minor','dim','major'],
    'mixolydian':     ['major','minor','dim','major','minor','minor','major'],
}

SCALE_PARENT = {
    'minor-pentatonic': 'natural-minor',
    'major-pentatonic': 'natural-major',
    'blues': 'natural-minor',
    'natural-minor': 'natural-minor',
    'natural-major': 'natural-major',
    'dorian': 'dorian',
    'mixolydian': 'mixolydian',
    'harmonic-minor': 'harmonic-minor',
}

# Which scale degrees to show chords for (0-indexed)
PROGRESSION_DEGREES = {
    'natural-minor':  [0, 2, 3, 4, 6],  # i III iv v VII
    'natural-major':  [0, 1, 3, 4, 5],  # I ii IV V vi
    'harmonic-minor': [0, 3, 4, 5],     # i iv V VI
    'dorian':         [0, 2, 3, 6],     # i III IV VII
    'mixolydian':     [0, 3, 4, 6],     # I IV v VII
}
```

### Chord tab rendering:

Chords are rendered as vertical stacks (all 6 strings show fret simultaneously).
Multiple chords shown side-by-side with spacing:

```
     Am       Dm       Em       C        G
  e|--5--|  e|--5--|  e|--0--|  e|--0--|  e|--3--|
  B|--5--|  B|--6--|  B|--0--|  B|--1--|  B|--3--|
  G|--5--|  G|--7--|  G|--0--|  G|--0--|  G|--0--|
  D|--7--|  D|--7--|  D|--2--|  D|--2--|  D|--0--|
  A|--7--|  A|--5--|  A|--2--|  A|--3--|  A|--2--|
  E|--5--|  E|--X--|  E|--0--|  E|--X--|  E|--3--|
```

---

## 3. File Changes

### File 1: `bin/mirador-tab-generator` (MODIFY)

Add at the end, before `main()`:

1. **`BARRE_SHAPES` dict** -- ~15 entries (shape data)
2. **`CHORD_TYPE_SHAPES` dict** -- maps chord type to default shape
3. **`DIATONIC_QUALITIES` dict** -- chord qualities per scale degree
4. **`SCALE_PARENT` dict** -- maps scale types to parent scale for harmony
5. **`PROGRESSION_DEGREES` dict** -- which degrees to show
6. **`get_chord_voicing(root, chord_type)`** -- returns 6-element list
7. **`get_companion_chords(root, scale_type)`** -- returns list of (name, voicing) tuples
8. **`render_chord_tab(voicings)`** -- renders multiple chords side-by-side as tab

Estimated additions: ~120 lines.

### File 2: `bin/mirador-tab-export` (MODIFY)

1. **Add `book` subcommand** to `main()` -- parallel to existing `reference` and `exercises`
2. **Add `build_book(scale_type, output)` function** -- the main orchestrator
3. **Modify `compile_pdf()`** -- run pdflatex TWICE (for TOC), increase timeout to 120s
4. **Add `KEY_ORDER` constant** -- [A, E, D, G, C, B, F#, Bb, Eb, Ab, Db, F]

Estimated additions: ~150 lines.

### File 3: `templates/complete_book.tex.j2` (NEW)

LaTeX template using `book` document class with:
- `\tableofcontents`
- `\part{Phase 1: Foundation}` / `\part{Phase 2: Sharps \& Flats}`
- `\chapter{Key of A Minor Pentatonic}`
- `\section{Scale Positions}`, `\section{Companion Chords}`, `\section{Exercises}`
- Verbatim blocks for tabs
- Portrait orientation (better for a "book" feel)
- Page numbers in footer
- Running headers showing current key

Estimated size: ~100 lines of template.

---

## 4. Implementation Sequence

### Step 1: Chord voicing system in `mirador-tab-generator`

Add to `bin/mirador-tab-generator`:
- `BARRE_SHAPES` data
- `CHORD_TYPE_SHAPES` mapping  
- `DIATONIC_QUALITIES` data
- `SCALE_PARENT` mapping
- `PROGRESSION_DEGREES` data
- `get_chord_voicing()` function
- `get_companion_chords()` function  
- `render_chord_tab()` function
- Add a `chord` CLI subcommand for testing: `mirador-tab-generator chord Am`

Test: `python3 bin/mirador-tab-generator chord Am` should output:
```
Companion chords for A Minor Pentatonic:
     Am       C        Dm       Em       G
  e|--5--|  e|--0--|  ...
```

### Step 2: Book template `templates/complete_book.tex.j2`

Create the Jinja2 template. Key LaTeX structure:

```latex
\documentclass[10pt]{book}
\usepackage[margin=0.75in]{geometry}
\usepackage{fancyvrb}
\usepackage{fancyhdr}
\usepackage{hyperref}
\usepackage[T1]{fontenc}
\usepackage{titlesec}

% Custom page style
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\small\leftmark}
\fancyfoot[C]{\thepage}

\setlength{\parindent}{0pt}
\setlength{\parskip}{4pt}

\begin{document}

% Title page
\begin{titlepage}
\centering
\vspace*{3cm}
{\Huge\bfseries Complete Guitar Scale Reference}\\[1cm]
{\Large << scale_type_display >>}\\[0.5cm]
{\large 12 Keys -- 5 Positions -- 8 Exercises -- Companion Chords}\\[2cm]
{\normalsize Generated by mirador-tab-generator}\\
{\small Verified fretboard math -- every note computed, not guessed}
\end{titlepage}

\tableofcontents
\newpage

<% for part in parts %>
\part{<< part.title >>}

<% for key in part.keys %>
\chapter{<< key.title >>}
{\small Notes: << key.notes_display >> | Degrees: << key.degrees_display >>}

\section{Scale Positions}
<% for pos in key.positions %>
\subsection*{Position << pos.number >> (frets << pos.fret_range >>)}
\begin{Verbatim}[fontsize=\small,xleftmargin=8pt]
<< pos.tab >>
\end{Verbatim}
{\footnotesize << pos.notes >>}
\vspace{4pt}
<% endfor %>

\section{Companion Chords}
\begin{Verbatim}[fontsize=\small,xleftmargin=8pt]
<< key.chord_tab >>
\end{Verbatim}
{\small Progression: << key.progression_text >>}

\section{Exercises}
<% for pos in key.positions %>
\subsection{Position << pos.number >> Exercises}
<% for ex in pos.exercises %>
\subsubsection*{<< ex.name >>}
\begin{Verbatim}[fontsize=\small,xleftmargin=8pt]
<< ex.tab >>
\end{Verbatim}
<% endfor %>
<% if not loop.last %>\newpage<% endif %>
<% endfor %>

<% endfor %>
<% endfor %>

\end{document}
```

Uses custom Jinja2 delimiters (`<% %>`, `<< >>`) consistent with existing templates.

### Step 3: Book builder in `mirador-tab-export`

Add `build_book()` function that:

1. Defines `KEY_ORDER` in two groups (Phase 1 / Phase 2)
2. For each key:
   - Generates 5 scale positions via `tab_gen.get_scale_positions()`
   - Generates companion chords via `tab_gen.get_companion_chords()`
   - Renders chord tab via `tab_gen.render_chord_tab()`
   - For each position, generates all 8 exercise types
   - Renders all tabs with `max_cols=MAX_COLS_PORTRAIT` (24)
3. Builds the context dict matching template structure
4. Renders template, compiles PDF

Add `book` to CLI:
```
mirador-tab-export book minor-pentatonic
mirador-tab-export book blues
mirador-tab-export book --all-scales   # (future: one book per scale type, or one mega-book)
```

### Step 4: Fix `compile_pdf()` for book builds

- Run pdflatex TWICE (first pass generates .aux/.toc, second pass resolves references)
- Increase timeout from 30s to 120s for the book
- Add a `runs=1` parameter defaulting to 1 for backward compat, set to 2 for book

```python
def compile_pdf(tex_content, output_path, runs=1, timeout=30):
    with tempfile.TemporaryDirectory() as tmpdir:
        tex_path = os.path.join(tmpdir, 'output.tex')
        with open(tex_path, 'w') as f:
            f.write(tex_content)
        for _ in range(runs):
            result = subprocess.run(
                [PDFLATEX, '-interaction=nonstopmode', '-output-directory', tmpdir, tex_path],
                capture_output=True, text=True, timeout=timeout
            )
        # ... rest unchanged
```

### Step 5: Test and verify

1. Generate single key: `python3 bin/mirador-tab-export book minor-pentatonic --key A`
2. Generate full book: `python3 bin/mirador-tab-export book minor-pentatonic`
3. Open PDF, verify TOC links, page breaks, tab accuracy
4. Check chord voicings are correct for each key

---

## 5. Layout Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Orientation | **Portrait** | Book feel; exercises wrap at 24 cols which fits portrait |
| Document class | **book** | Gives us parts, chapters, TOC, page numbers for free |
| Font size | **10pt** | Same as existing templates; readable monospace |
| Margins | **0.75in** | Same as exercises template; enough room for binding |
| Tab font | **\small monospace** (Verbatim) | Consistent with existing; proven readable |
| Exercises per page | **~2-4** depending on length | Let LaTeX handle page breaks naturally |
| Chapter breaks | **\chapter per key** | New page per key; clear visual separation |
| Scale type per book | **One book per scale type** | 8 possible books; minor-pentatonic is the first/default |

---

## 6. Companion Chord Progressions by Scale Type

For each scale type, show 4-5 diatonic chords and a suggested progression:

| Scale Type | Chords Shown | Suggested Progression |
|-----------|-------------|----------------------|
| minor-pentatonic | i, III, iv, v, VII | i - iv - VII - III |
| major-pentatonic | I, ii, IV, V, vi | I - IV - V - I |
| blues | i, IV, V (dom7 versions) | i7 - IV7 - V7 - i7 (12-bar) |
| natural-minor | i, III, iv, v, VI, VII | i - VI - III - VII |
| natural-major | I, ii, IV, V, vi | I - V - vi - IV |
| dorian | i, III, IV, VII | i - IV - VII - i |
| mixolydian | I, IV, v, VII | I - VII - IV - I |
| harmonic-minor | i, iv, V, VI | i - iv - V - i |

The progression text goes below the chord tabs as a simple one-liner.

---

## 7. Potential Challenges

1. **LaTeX compilation time**: 125+ pages with many Verbatim blocks. May need 60-120s. Solution: increased timeout.

2. **TOC depth**: With 12 chapters x (sections + subsections), the TOC could be 2-3 pages. Set `\setcounter{tocdepth}{1}` to show only chapters and sections, not subsections.

3. **Page breaks in exercises**: Long exercises (sequence3 = 30 events, wraps to 2 lines at 24 cols) should not split across pages. Use `\needspace{3cm}` before each exercise block or `\samepage` environment.

4. **Open chord voicings**: For keys like C, G, E, A, D -- the standard open chord shapes are more common than barre shapes. Consider adding open chord shapes to `BARRE_SHAPES` for these specific roots (with root fret = 0).

5. **Chord verification**: Each chord voicing should be verified against `CHORD_FORMULAS` to ensure every fretted note is actually in the chord. Add a `verify_chord_voicing()` function.

---

## 8. Open Chords Special Case

For roots that have common open shapes (C, D, E, G, A, F), override the barre shape with the open voicing:

```python
OPEN_CHORDS = {
    ('C', 'major'):  [None, 3, 2, 0, 1, 0],    # X32010
    ('D', 'major'):  [None, None, 0, 2, 3, 2],  # XX0232
    ('E', 'major'):  [0, 2, 2, 1, 0, 0],        # 022100
    ('G', 'major'):  [3, 2, 0, 0, 0, 3],        # 320003
    ('A', 'major'):  [None, 0, 2, 2, 2, 0],     # X02220
    ('A', 'minor'):  [None, 0, 2, 2, 1, 0],     # X02210
    ('E', 'minor'):  [0, 2, 2, 0, 0, 0],        # 022000
    ('D', 'minor'):  [None, None, 0, 2, 3, 1],  # XX0231
    ('C', 'major'):  [None, 3, 2, 0, 1, 0],     # X32010
    ('F', 'major'):  [1, 3, 3, 2, 1, 1],        # 133211 (barre but at fret 1)
}
```

`get_chord_voicing()` checks `OPEN_CHORDS` first, falls back to barre shapes.

---

## 9. Summary of All Changes

| File | Action | Lines Added/Changed |
|------|--------|-------------------|
| `bin/mirador-tab-generator` | ADD chord voicing system | ~120 lines |
| `bin/mirador-tab-export` | ADD `book` subcommand + `build_book()` | ~150 lines |
| `bin/mirador-tab-export` | MODIFY `compile_pdf()` for multi-run | ~10 lines changed |
| `templates/complete_book.tex.j2` | NEW template | ~100 lines |

Total: ~380 lines of new code, ~10 lines modified.

---

## 10. CLI Usage (Final)

```bash
# Generate the complete minor pentatonic reference book
mirador-tab-export book minor-pentatonic

# Generate blues scale book
mirador-tab-export book blues

# Generate for a specific key only (for testing)
mirador-tab-export book minor-pentatonic --key A

# Custom output path
mirador-tab-export book minor-pentatonic --output ~/Desktop/guitar-reference.pdf
```

Output: `~/.mirador/exports/minor-pentatonic_complete_book.pdf`
